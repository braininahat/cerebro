# S-JEPA pretraining smoke test config
#
# Runs 20 training steps + 2 validation steps to quickly validate:
# - Spatial block masking works correctly
# - L1 loss decreases
# - EMA updates properly
# - No shape mismatches
#
# Usage:
#   WANDB_MODE=offline timeout 60 uv run cerebro fit --config configs/sjepa/pretrain_smoke.yaml

seed_everything: 42
run_lr_finder: false
run_batch_size_finder: false

trainer:
  accelerator: auto
  devices: 1
  precision: 32-true  # Full precision for debugging
  gradient_clip_val: 1.0
  max_steps: 20  # Just 20 steps
  val_check_interval: 10  # Validate after 10 steps
  log_every_n_steps: 1

  logger:
    class_path: lightning.pytorch.loggers.WandbLogger
    init_args:
      project: eeg2025
      entity: ubcse-eeg2025
      name: sjepa_pretrain_smoke
      tags:
        - sjepa
        - pretrain
        - smoke
        - test
      save_dir: outputs/sjepa/pretrain_smoke/${now:%Y%m%d_%H%M%S}
      mode: offline

  callbacks:
    - class_path: lightning.pytorch.callbacks.ModelCheckpoint
      init_args:
        dirpath: outputs/sjepa/pretrain_smoke/${now:%Y%m%d_%H%M%S}/checkpoints
        filename: sjepa-{epoch:02d}-{val/loss:.4f}
        monitor: val/loss
        mode: min
        save_top_k: 1
        save_last: true

    - class_path: cerebro.callbacks.LatestCheckpointSymlinkCallback

    - class_path: lightning.pytorch.callbacks.TQDMProgressBar
      init_args:
        leave: true

model:
  class_path: cerebro.trainers.sjepa_pretrain.SJEPATrainer
  init_args:
    encoder:
      class_path: cerebro.models.components.encoders.VanillaSignalJEPAEncoder
      init_args:
        n_chans: 129
        n_times: 200
        sfreq: 100
        drop_prob: 0.0
        transformer__d_model: 64
        transformer__num_encoder_layers: 8
        transformer__nhead: 8

    mask_diameter_pct: 60  # Standard 60% mask
    ema_momentum: 0.996
    predictor_depth: 4
    predictor_heads: 8

    lr: 0.0001
    weight_decay: 0.05
    warmup_epochs: 0  # No warmup for smoke test
    max_epochs: 100

data:
  class_path: cerebro.data.jepa_pretrain.JEPAPretrainDataModule
  init_args:
    data_dir: ${oc.env:EEG2025_DATA_ROOT,./data}

    # Just R1 for speed
    releases:
      - R1

    # All 7 tasks
    all_tasks:
      - contrastChangeDetection
      - restingState
      - despicableMe
      - thePresent
      - diaryOfAWimpyKid
      - funwithFractals
      - surroundSupp

    window_length: 2.0
    stride: 1.0
    crop_length: null

    val_split: 0.2
    test_release: null

    n_chans_select: 129
    sfreq: 100
    mini: true  # Mini dataset for speed

    batch_size: 32  # Small batch for speed
    num_workers: 4
